<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Makkah Hotel & Towers Reservation System</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator_simple.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/microsoft-graph-client/lib/graph-js-sdk.js"></script>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script >//src="https://unpkg.com/@adminkit/core@latest/dist/js/app.js"</script>
    
</head>

<body>
    <!-- Login -->
    <div id="Login" class="container mt-4 ">
        <div class="d-flex justify-content-center">
            <img class="logo " src="Logo.jpg">
        </div>
        <p class="Mainfont" style="text-align: center;">
            Welcome to Makkah Hotel and Towers Restaurant Manager App Please Log In</p>
        <div class="d-flex justify-content-center">
            <button id="triggerFlow" class="button1 Mainfont" style="margin-left: auto; margin-right: auto;"><img
                    src="microsoft-icon.png" style="width:40px;height:40px;"> Login</button>
        </div>
        <!-- Login Script-->
        <script>


            const msalConfig = {
                auth: {
                    clientId: 'e0acb094-b083-4a26-9899-b619fd4fbe35', // Your client ID
                    authority: 'https://login.microsoftonline.com/d6d28ff2-102e-428d-bca8-101df3e61808'
                }
            };
            LoggedIn_User = "";
            const msalInstance = new msal.PublicClientApplication(msalConfig);

            async function getAccessTokenPA() {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    await msalInstance.loginPopup();
                }
                const activeAccount = msalInstance.getAllAccounts()[0];
                msalInstance.setActiveAccount(activeAccount);
                try {
                    const tokenResponse = await msalInstance.acquireTokenSilent({
                        scopes: ['https://service.flow.microsoft.com//.default'], // Ensure correct scope
                    });
                    // **Extract Claims** - You can decode the JWT to check claims
                    const jwtPayload = JSON.parse(atob(tokenResponse.accessToken.split('.')[1]));
                    LoggedIn_User = jwtPayload.upn;
                    // Optional: Log extracted claims for verification
                    console.log("JWT Claims:", jwtPayload);
                    return tokenResponse.accessToken;
                } catch (error) {
                    console.error("Error acquiring access token:", error);
                    if (error instanceof msal.InteractionRequiredAuthError) {
                        await msalInstance.loginPopup();
                        return getAccessToken(); // Retry
                    }
                    throw error;
                }
            }

            async function getAccessToken() {
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length === 0) {
                    await msalInstance.loginPopup();
                }
                const activeAccount = msalInstance.getAllAccounts()[0];
                msalInstance.setActiveAccount(activeAccount); // Set the active account

                try {
                    const tokenResponse = await msalInstance.acquireTokenSilent({
                        scopes: ["Files.Read"], // Ensure correct scope
                    });
                    LoggedIn_User = tokenResponse.account.username;
                    return tokenResponse.accessToken;
                } catch (error) {
                    console.error("Error acquiring access token:", error);
                    if (error instanceof msal.InteractionRequiredAuthError) {
                        await msalInstance.loginPopup();
                        return getAccessToken(); // Retry
                    }
                    throw error;
                }
            }

            document.getElementById("triggerFlow").onclick = async () => {
                try {
                    await msalInstance.loginPopup();
                    await getfiles(); // Call getfiles after login
                } catch (error) {
                    console.error("Login failed:", error);
                }
            };

            const getfiles = async () => {
    try {
        const accessToken = await getAccessToken();
        const client = MicrosoftGraph.Client.init({
            authProvider: (done) => {
                done(null, accessToken);
            }
        });

        Loading();

        // File IDs
        const fileIds = [
            'u!aHR0cHM6Ly9tYWtobnQtbXkuc2hhcmVwb2ludC5jb20vOnQ6L2cvcGVyc29uYWwvYWFsbWFsa2lfbWFra2FoLWhudF9jb20vRVh6ODF3RzYzNFZHaE1ocmtLVEJKUE1CWjVxX1JGNG9JTlRfcEhQdVZVUDhZZw',
            'u!aHR0cHM6Ly9tYWtobnQtbXkuc2hhcmVwb2ludC5jb20vOnQ6L2cvcGVyc29uYWwvYWFsbWFsa2lfbWFra2FoLWhudF9jb20vRWZWVlBhR1hub05CcFh3Sk9Ca3JoY0lCMzdOVkZIajFfeWZ1bWt0WFpGV2J2dw',
            'u!aHR0cHM6Ly9tYWtobnQtbXkuc2hhcmVwb2ludC5jb20vOnQ6L2cvcGVyc29uYWwvYWFsbWFsa2lfbWFra2FoLWhudF9jb20vRVEyQ2d2blBGMlZQazNfbFpoQXZ2UFFCZkw5Q0JwWjZwWjd3bnNYVGlOQUk4QQ'
        ];

        // Fetch all files
        const contents = await Promise.all(
            
            fileIds.map(id => 
            
            client.api(`/shares/${id}/driveItem/content`).get()

               // client.api(`/shares/drive/items/${id}/content`).get()
                //old  client.api(`/me/drive/items/${id}/content`).get()
            )
        );

        // Combine contents
        let temp = contents[0] + contents[1];
        temp += '<Main>' + contents[2] + '</Main>';

        // Process XML
        temp = replaceSecondOccurrence(temp, '<?xml version="1.0" encoding="UTF-8"?>', '');
        temp = replaceSecondOccurrence(temp, '<!-- Generated by Oracle Reports version 12.2.1.3.0 -->', '');
        temp = replaceSecondOccurrence(temp, '<PKGFORECAST>', '');
        temp = temp.replaceAll('</PKGFORECAST>', '')
                   .replaceAll('</Main>', '</Main></PKGFORECAST>');

        // Parse and display
        xmlDoc = parser.parseFromString(temp, 'text/xml');
        const searchValue = document.getElementById('i1diwy').value;
        DisplayResult(searchValue || 'inis');
        Table_Update();
        showPage();

    } catch (error) {
        console.error('Error:', error);
    }
};

function timeinterval() {
    GetRoomDetail(true);
}
        </script>
    </div>
    <!-- Loader -->
    <div id="loader" style="display:none;"></div>
    <!-- Main -->
    <div id="MainLoader" style="display:none;">
        <main>
            <div class="container mt-4">
                <!-- Logo -->
                <div class="text-center">
                    <img src="Logo.jpg" alt="Makkah Hotel & Towers Logo" class="logo">
                </div>
                <div class="text-center Mainfont">
                    Welcome to Makkah Hotel and Towers Restaurant Manager App
                </div>
                <!-- Search Bar -->
                <div class="search-bar input-group mb-3">
                    <input id="i1diwy" type="text" class="form-control" placeholder="Room Number"
                        style="text-align: center; box-shadow: 0px 0px 13px #000000; text-shadow: 0px 0px 0px #000000; border: 0 solid #FFFFFF; border-radius: 14px 14px 14px 14px; font-size: 19px; letter-spacing: 4px; line-height: 30px;">
                </div>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-dark align-items" type="button"
                        onclick="DisplayResult(document.getElementById('i1diwy').value);">Search</button>
                    <button class="btn btn-primary align-items" type="button" onclick="getfiles();" style="margin-left: 15px;">Refresh</button>
                </div>
                <!-- Information Panels -->
                <div class="row mb-4">
                    <!-- Guest Information -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Guest Information:</div>
                            <div class="card-body" style="margin-bottom: 32px;">
                                <p><strong>Guest Name:</strong>
                                    <span id="i1awj11"></span>
                                </p>
                                <p><strong>Guest Reservation ID:</strong>
                                    <span id="i9px111"></span>
                                </p>
                                <p><strong>Guest Package:</strong>
                                    <span id="io71h11"></span>
                                </p>
                                <p><strong>Adults:</strong>
                                    <span id="id41u11"></span>
                                </p>
                                <p><strong>Childrens:</strong>
                                    <span id="id41u22"></span>
                                </p>
                                <p><strong>Available Adults:</strong>
                                    <span id="id41u1112" style="color: red;"></span>
                                </p>
                                <p><strong>Available Childrens:</strong>
                                    <span id="id41u2212" style="color: red;"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <!-- Guest Information (Right Panel) -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Entries Information:</div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label>Please Enter Number of Adult's:</label>
                                    <input id="i1diwy1" type="number" class="form-control" value="0">
                                </div>
                                <div class="mb-3">
                                    <label>Please Enter Number of Children's:</label>
                                    <input id="i1diwy2" type="number" class="form-control" value="0">
                                </div>
                                <div class="mb-3">
                                    <label>Please Select Restaurant:</label>
                                    <select class="form-select" id="i1diwy3">
                                        <option id="i1diwy4" value="Lagenda">Lagenda</option>
                                        <option id="i1diwy5" value="Alfayha">Alfayha</option>
                                        <option id="i1diwy6" value="Alandalus">Alandalus</option>
                                        <option id="i1diwy7" value="Alnoor">Alnoor</option>
                                        <option id="i1diwy8" value="Alamber">Alamber</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label>Current Period:</label>
                                    <select class="form-select" id="i1diwy33" disabled>
                                        <option id="i1diwy44" value="Breakfast">Breakfast</option>
                                        <option id="i1diwy55" value="Lunch">Lunch</option>
                                        <option id="i1diwy66" value="Dinner">Dinner</option>
                                        <option id="i1diwy88" value="Fator">Fator</option>
                                        <option id="i1diwy77" value="Sahour">Sahour</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button class="btn btn-success" onclick="UpdateRES();">Update</button>
                    </div>
                </div>
                <!-- Table filter -->
                <div class="card">
                    <div class="card-header">Entries History</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <label for="filter-field">Field</label>
                                <select id="filter-field" class="form-select">
                                    <option></option>
                                    <option value="UserName">UserName</option>
                                    <option value="Restaurant">Restaurant</option>
                                    <option value="Room_Number">Room Number</option>
                                    <option value="Reservation_Number">eservation Number</option>
                                    <option value="Adult_Entered">Adult Entered</option>
                                    <option value="Children_Entered">Children Entered</option>
                                    <option value="Period">Period</option>
                                    <option value="Time_Of_Entry">Time Of Entry</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="filter-type">Condition</label>
                                <select id="filter-type" class="form-select">
                                    <option value="like">like</option>
                                    <option value="=">=</option>
                                    <option value="<">
                                        << /option>
                                    <option value="<=">>=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                    <option value="!=">!=</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="filter-value">Value</label>
                                <input class="form-control" id="filter-value" type="text" placeholder="Value to filter">
                            </div>
                            <div class="d-flex align-items-end col">
                                <button id="filter-clear" style="margin-bottom: 0px;" class="btn btn-dark">Clear
                                    Filter</button>
                            </div>
                            <div>
                                <button class="btn btn-dark" id="download-csv">Download CSV</button>
                            </div>
                        </div>

                        <br>
                        <div id="example-table" style="margin-bottom: 10px;"></div>
                    </div>
                </div>
                <div class="row mb-4">


                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Entries History</div>
                            <div class="card-body">
                                <canvas id="chartjs-bar">
                                </canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Entries History</div>
                            <div class="card-body">
                                <canvas id="chartjs-bar1">
                                </canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <button onclick=" async function logout() {await msalInstance.logoutPopup(); location.reload()}; logout();">
                    Logout
                </button>
            </div>
        </main>
</body>
<script>
    //Define variables for input elements
    var fieldEl = document.getElementById("filter-field");
    var typeEl = document.getElementById("filter-type");
    var valueEl = document.getElementById("filter-value");
    //Custom filter example
    function customFilter(data) {
        return data.car && data.rating < 3;
    }
    //Trigger setFilter function with correct parameters
    function updateFilter() {
        var filterVal = fieldEl.options[fieldEl.selectedIndex].value;
        var typeVal = typeEl.options[typeEl.selectedIndex].value;
        var filter = filterVal == "function" ? customFilter : filterVal;
        if (filterVal == "function") {
            typeEl.disabled = true;
            valueEl.disabled = true;
        } else {
            typeEl.disabled = false;
            valueEl.disabled = false;
        }
        if (filterVal) {
            table.setFilter(filter, typeVal, valueEl.value);
        }
    }
    //Update filters on value change
    document.getElementById("filter-field").addEventListener("change", updateFilter);
    document.getElementById("filter-type").addEventListener("change", updateFilter);
    document.getElementById("filter-value").addEventListener("keyup", updateFilter);
    //Clear filters on "Clear Filters" button click
    document.getElementById("filter-clear").addEventListener("click", function () {
        fieldEl.value = "";
        typeEl.value = "=";
        valueEl.value = "";
        table.clearFilter();
    });
    document.getElementById("download-csv").addEventListener("click", function () {
        table.download("csv", "data.csv");
    });
    //Build Tabulator
    var table = new Tabulator("#example-table", {
        responsiveLayout: "collapse",
        layout: "fitDataStretch",
        resizableColumnFit: true,
        pagination: "local",
        paginationSize: 10,
        paginationSizeSelector: [10, 50, 100],
        movableColumns: true,
        paginationCounter: "rows",
        columns: [
            { title: "UserName", field: "UserName" },
            { title: "Restaurant", field: "Restaurant" },
            { title: "Room Number", field: "Room_Number" },
            { title: "Reservation Number", field: "Reservation_Number", sorter: "number" },
            { title: "Adult Entered", field: "Adult_Entered" },
            { title: "Children Entered", field: "Children_Entered" },
            { title: "Period", field: "Period" },
            { title: "Time Of Entry", field: "Time_Of_Entry" },
        ],
    });
    function showPage() {
        document.getElementById("loader").style.display = "none";
        document.getElementById("Login").style.display = "none";
        document.getElementById("MainLoader").style.display = "block";
    }
    function Loading() {
        document.getElementById("loader").style.display = "block";
        document.getElementById("MainLoader").style.display = "none";
        document.getElementById("Login").style.display = "none";
    }
    function replaceSecondOccurrence(str, substringToReplace, replacement) {
        const firstIndex = str.indexOf(substringToReplace);
        if (firstIndex !== -1) {
            const secondIndex = str.indexOf(substringToReplace, firstIndex + 1);
            if (secondIndex !== -1) {
                const modifiedString = str.substring(0, secondIndex) + replacement + str.substring(secondIndex + substringToReplace.length);
                return modifiedString;
            }
        }
        return str;
    }
    parser = new DOMParser();
    var xmlDoc = "";
    parser2 = new DOMParser();
    var xmlAvalib = "";
    function xmlToObject(xml) {
        const obj = {};
        // Process attributes
        if (xml.nodeType === 1) { // Element
            if (xml.attributes.length > 0) {
                obj["@attributes"] = {};
                for (let j = 0; j < xml.attributes.length; j++) {
                    const attribute = xml.attributes.item(j);
                    obj["@attributes"][attribute.nodeName] = attribute.nodeValue;
                }
            }
        } else if (xml.nodeType === 3) { // Text
            return xml.nodeValue.trim();
        }
        // Process child nodes
        if (xml.hasChildNodes()) {
            for (let i = 0; i < xml.childNodes.length; i++) {
                const item = xml.childNodes.item(i);
                const nodeName = item.nodeName;

                if (typeof (obj[nodeName]) === "undefined") {
                    obj[nodeName] = xmlToObject(item);
                } else {
                    if (Array.isArray(obj[nodeName])) {
                        obj[nodeName].push(xmlToObject(item));
                    } else {
                        obj[nodeName] = [obj[nodeName], xmlToObject(item)];
                    }
                }
            }
        }
        // Simplify single-item arrays
        for (const key in obj) {
            if (Array.isArray(obj[key]) && obj[key].length === 1) {
                obj[key] = obj[key][0]; // Convert single-item arrays to plain objects
            }
        }
        return obj;
    }
    function findReservations(data, ToFind) {
        ArraytoSerch = data.PKGFORECAST.LIST_G_PRODUCT_GROUP[1].G_PRODUCT_GROUP.LIST_G_RESV_DETAILS.G_RESV_DETAILS; // Access the array of reservations
        // Iterate through reservations to find the specified room number
        for (const Key of ArraytoSerch) {
            if (Key.ROOM['#text'] === ToFind) {
                return Key; // Return the reservation if found
            }
        }
        ArraytoSerch = data.PKGFORECAST.LIST_G_PRODUCT_GROUP[0].G_PRODUCT_GROUP.LIST_G_RESV_DETAILS.G_RESV_DETAILS;
        for (const Key of ArraytoSerch) {
            if (Key.ROOM['#text'] === ToFind) {
                return Key; // Return the reservation if found
            }
        }
        return false; // Return null if no reservation is found
    }
    function DisplayResult(RoomNmuber) {
        XMLobj = xmlToObject(xmlDoc)
        SetCurrentPeriod();
        found = false
        if (RoomNmuber == "inis") {
            Table_Update();
        } else {
            const length_conf = xmlDoc.getElementsByTagName("CONFIRMATION_NO").length - 1;
            if (findReservation = false) {
                alert("Room Not Found")
            } else {
                Reservation_Dtl = findReservations(XMLobj, RoomNmuber);
                if(Reservation_Dtl==false){
                    alert("Room Not Found");
                }else{
                document.getElementById('i9px111').innerHTML = Reservation_Dtl.CONFIRMATION_NO['#text'];
                document.getElementById('i1awj11').innerHTML = Reservation_Dtl.DISPLAY_NAME['#text'];
                document.getElementById('io71h11').innerHTML = Reservation_Dtl.PRODUCTS['#text'];
                document.getElementById('id41u11').innerHTML = Reservation_Dtl.ADULTS['#text'];
                document.getElementById('id41u11').innerHTML = Reservation_Dtl.ADULTS['#text'];
                document.getElementById('id41u22').innerHTML = Reservation_Dtl.CHILDREN['#text'];

                    if(Reservation_Dtl.RESV_STATUS['#text'] != 'CHECKED IN'){
                                document.getElementById('i1diwy1').max = 0
                                    document.getElementById('id41u1112').innerHTML='Room Is Not Checked in Please wait for update';
                                document.getElementById('i1diwy1').max = 0
                                    document.getElementById('id41u2212').innerHTML='Room Is Not Checked in Please wait for update';        
                    }
                AdEntered = 0;
                ChEntered = 0;
                enter = false
                found = true
            }

                
            for (let index = 0; index < length_conf; index++) {
                if (xmlDoc.getElementsByTagName("RESV_STATUS")[index].childNodes[0].nodeValue == "CHECKED IN") {
                    if (xmlDoc.getElementsByTagName("ROOM")[index].childNodes[0].nodeValue == RoomNmuber) {
                        document.getElementById('i9px111').innerHTML = xmlDoc.getElementsByTagName("CONFIRMATION_NO")[index].childNodes[0].nodeValue;
                        document.getElementById('i1awj11').innerHTML = xmlDoc.getElementsByTagName("DISPLAY_NAME")[index].childNodes[0].nodeValue;
                        document.getElementById('io71h11').innerHTML = xmlDoc.getElementsByTagName("PRODUCTS")[index].childNodes[0].nodeValue;
                        document.getElementById('id41u11').innerHTML = xmlDoc.getElementsByTagName("ADULTS")[index].childNodes[0].nodeValue;
                        document.getElementById('id41u22').innerHTML = xmlDoc.getElementsByTagName("CHILDREN")[index].childNodes[0].nodeValue;
                        AdEntered = 0;
                        ChEntered = 0;
                        enter = false
                        found = true
                        for (let jndex = xmlDoc.getElementsByTagName("ResID").length - 1; jndex >= 0; jndex--) {
                            MonthdateconvRes = new Date(parseInt(xmlDoc.getElementsByTagName("DateOfEntrie")[jndex].childNodes[0].nodeValue)).getMonth();
                            MonthdateconvNow = new Date().getMonth();
                            DaydateconvRes = new Date(parseInt(xmlDoc.getElementsByTagName("DateOfEntrie")[jndex].childNodes[0].nodeValue)).getDate();
                            DaydateconvNow = new Date().getDate();
                            if ((xmlDoc.getElementsByTagName("ResID")[jndex].childNodes[0].nodeValue == xmlDoc.getElementsByTagName("CONFIRMATION_NO")[index].childNodes[0].nodeValue) && (xmlDoc.getElementsByTagName("Period")[jndex].childNodes[0].nodeValue == CurrentPeriod) && (DaydateconvRes == DaydateconvNow) && (MonthdateconvRes == MonthdateconvNow)) {
                                AdEntered = AdEntered + parseInt(xmlDoc.getElementsByTagName("ADEnt")[jndex].childNodes[0].nodeValue);
                                ChEntered = ChEntered + parseInt(xmlDoc.getElementsByTagName("CHEnt")[jndex].childNodes[0].nodeValue);
                                enter = true;
                            }
                            dateconv = new Date(parseInt(xmlDoc.getElementsByTagName("DateOfEntrie")[jndex].childNodes[0].nodeValue));
                            formattedStringDate = dateconv.toLocaleString();
                            let newRow = [xmlDoc.getElementsByTagName("HostName")[jndex].childNodes[0].nodeValue, xmlDoc.getElementsByTagName("Restaurant")[jndex].childNodes[0].nodeValue, xmlDoc.getElementsByTagName("RoomNumber")[jndex].childNodes[0].nodeValue, xmlDoc.getElementsByTagName("ResID")[jndex].childNodes[0].nodeValue, xmlDoc.getElementsByTagName("ADEnt")[jndex].childNodes[0].nodeValue, xmlDoc.getElementsByTagName("CHEnt")[jndex].childNodes[0].nodeValue, xmlDoc.getElementsByTagName("Period")[jndex].childNodes[0].nodeValue, formattedStringDate];
                            //dataTable.rows.add(newRow);
                            if (enter) {
                                document.getElementById('id41u1112').innerHTML = document.getElementById('id41u11').innerHTML - AdEntered;
                                document.getElementById('id41u2212').innerHTML = document.getElementById('id41u22').innerHTML - ChEntered;

                                                                if ( document.getElementById('id41u1112').innerHTML == '') {
                                document.getElementById('i1diwy1').max = 0
                                    document.getElementById('id41u1112').innerHTML='0';
                                }                                if ( document.getElementById('id41u2212').innerHTML == '') {
                                document.getElementById('i1diwy1').max = 0
                                    document.getElementById('id41u2212').innerHTML='0';
                                }
                                document.getElementById('i1diwy1').max = document.getElementById('id41u1112').innerHTML
                                document.getElementById('i1diwy2').max = document.getElementById('id41u2212').innerHTML
                                document.getElementById('i1diwy1').min = 0;
                                document.getElementById('i1diwy2').min = 0;
                                document.getElementById('i1diwy1').value = 0;
                                document.getElementById('i1diwy2').value = 0;
                            } else {
                                                                                                if ( document.getElementById('id41u1112').innerHTML == '') {
                                document.getElementById('i1diwy1').max = 0
                                    document.getElementById('id41u1112').innerHTML='0';
                                }                                if ( document.getElementById('id41u2212').innerHTML == '') {
                                document.getElementById('i1diwy1').max = 0
                                    document.getElementById('id41u2212').innerHTML='0';
                                }
                                
                                document.getElementById('id41u1112').innerHTML = document.getElementById('id41u11').innerHTML;
                                document.getElementById('id41u2212').innerHTML = document.getElementById('id41u22').innerHTML;


                                document.getElementById('i1diwy1').max = document.getElementById('id41u11').innerHTML
                                document.getElementById('i1diwy2').max = document.getElementById('id41u22').innerHTML
                                document.getElementById('i1diwy1').min = 0;
                                document.getElementById('i1diwy2').min = 0;
                                document.getElementById('i1diwy1').value = 0;
                                document.getElementById('i1diwy2').value = 0;
                            }
                        }
                    }
                }
            }
        }
        //Table_Update();
    }
                                                                                              
}
    const appendToOneDriveFile = async (newContent, itemId) => {
    try {
        const accessToken = await getAccessToken();
        const client = MicrosoftGraph.Client.init({
            authProvider: (done) => {
                done(null, accessToken);
            }
        });

        // First, get the current content
        const currentContent = await client.api(`/shares/${itemId}/driveItem/content`)
            .get();

        // Append new content
        const updatedContent = currentContent + newContent;

        // Upload the updated content
        const blob = new Blob([updatedContent], { type: 'text/plain' });
        await client.api(`/shares/${itemId}/driveItem/content`)
            .put(blob);

        return { success: true, message: 'Content appended successfully' };

    } catch (error) {
        console.error('Error appending to file:', error);
        alert('Error:' +  error)
       // return { success: false, message: error.message };
    }
};

// await appendToOneDriveFile('contant', 'FileID');

    function SetCurrentPeriod() {
        dperiod = new Date;
        CurrentPeriod = "";
        if (dperiod.getHours() > 6 && dperiod.getHours() < 12) {
            CurrentPeriod = "Breakfast";
        } else if (dperiod.getHours() >= 12 && dperiod.getHours() < 18) {
            CurrentPeriod = "Lunch";
        } else if (dperiod.getHours() >= 18) {
            CurrentPeriod = "Dinner";
        } else {
            CurrentPeriod = "Dinner";
        }
        document.getElementById("i1diwy33").value = CurrentPeriod;
    }
     statc_Lagenda=[0,0,0,0,0,0,0];
     statc_Alfayha=[0,0,0,0,0,0,0];
     statc_Alnoor=[0,0,0,0,0,0,0];
     statc_Alandalus=[0,0,0,0,0,0,0];
     statc_Alamber=[0,0,0,0,0,0,0];
    function Table_Update() {
     statc_Lagenda=[0,0,0,0,0,0,0];
     statc_Alfayha=[0,0,0,0,0,0,0];
     statc_Alnoor=[0,0,0,0,0,0,0];
     statc_Alandalus=[0,0,0,0,0,0,0];
     statc_Alamber=[0,0,0,0,0,0,0];
        table.clearData();
        let newRows = [];
        for (let jndex = xmlDoc.getElementsByTagName("ResID").length - 1; jndex >= 0; jndex--) {
            MonthdateconvRes = new Date(parseInt(xmlDoc.getElementsByTagName("DateOfEntrie")[jndex].childNodes[0].nodeValue)).getMonth();
            MonthdateconvNow = new Date().getMonth();
            DaydateconvRes = new Date(parseInt(xmlDoc.getElementsByTagName("DateOfEntrie")[jndex].childNodes[0].nodeValue)).getDate();
            DaydateconvNow = new Date().getDate();
            dateconv = new Date(parseInt(xmlDoc.getElementsByTagName("DateOfEntrie")[jndex].childNodes[0].nodeValue));
            formattedStringDate = dateconv.toLocaleString();
            newRows.push({ UserName: xmlDoc.getElementsByTagName("HostName")[jndex].childNodes[0].nodeValue, Restaurant: xmlDoc.getElementsByTagName("Restaurant")[jndex].childNodes[0].nodeValue, Room_Number: xmlDoc.getElementsByTagName("RoomNumber")[jndex].childNodes[0].nodeValue, Reservation_Number: xmlDoc.getElementsByTagName("ResID")[jndex].childNodes[0].nodeValue, Adult_Entered: xmlDoc.getElementsByTagName("ADEnt")[jndex].childNodes[0].nodeValue, Children_Entered: xmlDoc.getElementsByTagName("CHEnt")[jndex].childNodes[0].nodeValue, Period: xmlDoc.getElementsByTagName("Period")[jndex].childNodes[0].nodeValue, Time_Of_Entry: formattedStringDate });
            var t=new Date(formattedStringDate)
            var t7=new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            if(t>t7){
            if (xmlDoc.getElementsByTagName("Restaurant")[jndex].childNodes[0].nodeValue=="Lagenda") {
                statc_Lagenda[t.getDay()]=parseInt(statc_Lagenda[t.getDay()])+(parseInt(xmlDoc.getElementsByTagName("ADEnt")[jndex].childNodes[0].nodeValue) + parseInt(xmlDoc.getElementsByTagName("CHEnt")[jndex].childNodes[0].nodeValue))
            }else if (xmlDoc.getElementsByTagName("Restaurant")[jndex].childNodes[0].nodeValue=="Alfayha") {
                statc_Alfayha[t.getDay()]=parseInt(statc_Alfayha[t.getDay()])+(parseInt(xmlDoc.getElementsByTagName("ADEnt")[jndex].childNodes[0].nodeValue) + parseInt(xmlDoc.getElementsByTagName("CHEnt")[jndex].childNodes[0].nodeValue))
            }else if (xmlDoc.getElementsByTagName("Restaurant")[jndex].childNodes[0].nodeValue=="Alnoor") {
                statc_Alnoor[t.getDay()]=parseInt(statc_Alnoor[t.getDay()])+(parseInt(xmlDoc.getElementsByTagName("ADEnt")[jndex].childNodes[0].nodeValue) + parseInt(xmlDoc.getElementsByTagName("CHEnt")[jndex].childNodes[0].nodeValue))
            }else if (xmlDoc.getElementsByTagName("Restaurant")[jndex].childNodes[0].nodeValue=="Alandalus") {
                statc_Alandalus[t.getDay()]=parseInt(statc_Alandalus[t.getDay()])+(parseInt(xmlDoc.getElementsByTagName("ADEnt")[jndex].childNodes[0].nodeValue) + parseInt(xmlDoc.getElementsByTagName("CHEnt")[jndex].childNodes[0].nodeValue))
            }else if (xmlDoc.getElementsByTagName("Restaurant")[jndex].childNodes[0].nodeValue=="Alamber") {
                statc_Alamber[t.getDay()]=parseInt(statc_Alamber[t.getDay()])+(parseInt(xmlDoc.getElementsByTagName("ADEnt")[jndex].childNodes[0].nodeValue) + parseInt(xmlDoc.getElementsByTagName("CHEnt")[jndex].childNodes[0].nodeValue))
            }
        }
        }
        table.setData(newRows, true);
        CreateGraph("Update");
    }

    ctx="";
    chart="";
    function CreateGraph(CreateCAN) {
if(CreateCAN=="Create"){
         ctx = document.getElementById('chartjs-bar');

const data = {
    labels: ['Sunday','Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
    datasets: [
        { label: 'Lagenda', data: statc_Lagenda, backgroundColor: '#CB4335' },
        { label: 'Alfayha', data: statc_Alfayha, backgroundColor: '#1F618D' },
        { label: 'Alnoor', data: statc_Alnoor, backgroundColor: '#F1C40F' },
        { label: 'Alandalus', data: statc_Alandalus, backgroundColor: '#27AE60' },
        { label: 'Alamber', data: statc_Alamber, backgroundColor: '#884EA0' }
    ]
};

// Create the chart
chart = new Chart(ctx, {
    type: 'bar',
    data: data,
    options: {
        tooltips: {
                        mode: 'index',
                        intersect: false
                    },
        responsive: true,
        scales: {
            x: { stacked: true },
            y: { beginAtZero: true, stacked: true }
        }
    }
});}else if (CreateCAN=="Update") {
    chart.data.datasets[0].data=statc_Lagenda;
    chart.data.datasets[1].data=statc_Alfayha;
    chart.data.datasets[2].data=statc_Alnoor;
    chart.data.datasets[3].data=statc_Alandalus;
    chart.data.datasets[4].data=statc_Alamber;
    chart.update();
}else{

}

    }
    async function UpdateRES() {
        currentDate = new Date();
        AvalDate = `
    <Reservation>
    <HostName>`+ LoggedIn_User + `</HostName>
    <Restaurant>`+ document.getElementById('i1diwy3').value + `</Restaurant>
    <ResID>`+ document.getElementById('i9px111').innerHTML + `</ResID>
    <RoomNumber>`+ document.getElementById('i1diwy').value + `</RoomNumber>
    <ADEnt>`+ parseInt(document.getElementById('i1diwy1').value) + `</ADEnt>
    <CHEnt>`+ parseInt(document.getElementById('id41u2212').innerHTML) + `</CHEnt>
    <Period>`+ document.getElementById('i1diwy33').value + `</Period>
    <DateOfEntrie>`+ currentDate.getTime() + `</DateOfEntrie>
    </Reservation>
    `;
        AvalDate.replaceAll("\n", "").replaceAll("\t", "").replaceAll(" ", "");
        if ((parseInt(document.getElementById('i1diwy1').value) <= parseInt(document.getElementById('id41u11').innerHTML)) && (parseInt(document.getElementById('i1diwy2').value) <= parseInt(document.getElementById('id41u22').innerHTML)) && (document.getElementById('i1diwy1').value != "") && (document.getElementById('i1diwy2').value != "") && (parseInt(document.getElementById('i1diwy1').value) != 0 || parseInt(document.getElementById('i1diwy2').value) != 0) && (parseInt(document.getElementById('i1diwy1').value) >= 0 && parseInt(document.getElementById('i1diwy2').value) >= 0)) {
            Loading();
            WriteResult=await appendToOneDriveFile(AvalDate, 'u!aHR0cHM6Ly9tYWtobnQtbXkuc2hhcmVwb2ludC5jb20vOnQ6L2cvcGVyc29uYWwvYWFsbWFsa2lfbWFra2FoLWhudF9jb20vRVEyQ2d2blBGMlZQazNfbFpoQXZ2UFFCZkw5Q0JwWjZwWjd3bnNYVGlOQUk4QQ');
                if(WriteResult.success){
                         GetRoomDetail(); // Wait for getdetailed() function to complete
                        document.getElementById('id41u1112').innerHTML = parseInt(document.getElementById('id41u1112').innerHTML) - parseInt(document.getElementById('i1diwy1').value);
                        document.getElementById('id41u2212').innerHTML = parseInt(document.getElementById('id41u2212').innerHTML) - parseInt(document.getElementById('i1diwy2').value);
                        document.getElementById('i1diwy1').max = document.getElementById('id41u1112').innerHTML;
                        document.getElementById('i1diwy2').max = document.getElementById('id41u2212').innerHTML;
                        document.getElementById('i1diwy1').value = 0;
                        document.getElementById('i1diwy2').value = 0;
                        showPage();
                                                                                                                    if ( document.getElementById('id41u1112').innerHTML == '') {
                                document.getElementById('i1diwy1').max = 0
                                    document.getElementById('id41u1112').innerHTML='0';
                                }                                if ( document.getElementById('id41u2212').innerHTML == '') {
                                document.getElementById('i1diwy1').max = 0
                                    document.getElementById('id41u2212').innerHTML='0';
                                }
                }else{


                }

        }
        else {
            alert("Cannot Send Update, please check guest availability")
        }
 
    }
    async function GetRoomDetail(inf) {
        getfiles()
    };
    CreateGraph("Create");
</script>

</html>
